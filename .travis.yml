matrix:
  dist: bionic
  include:
    - name: run unit tests
      language: python
      python:
        - "3.7"
      env:
        - PYTHONPATH=haven/
      install:
        - pip install -r requirements/test.txt
      script:
        - pytest --cov-config=haven/.coveragerc --cov-report term-missing --cov haven
    - name: check for missing migrations
      language: python
      python:
        - "3.7"
      env:
        - PYTHONPATH=haven/
      install:
        - pip install -r requirements/test.txt
      script:
        - haven/manage.py makemigrations --check --dry-run --settings=config.settings.test
    - name: verify built JS files are up to date
      language: node_js
      node_js:
        - 10
      before_script:
        - npm install -g gulp-cli
      script:
        - cd haven/static
        - npm install
        - gulp
        - git diff --exit-code --numstat
    - name: run deployment checks
      language: python
      python:
        - "3.7"
      env:
        - PYTHONPATH=haven/
        - SECRET_KEY='notasecret'
      addons:
        apt:
          packages:
            - unixodbc-dev
      install:
        - pip install -r requirements/production.txt
      script:
        - haven/manage.py check --deploy --settings=config.settings.production

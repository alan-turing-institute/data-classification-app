matrix:
  dist: bionic
  include:
    - name: run unit tests
      language: python
      python:
        - "3.8"
      before_install:
        - pip install poetry
        - psql -c 'create database haven;' -U postgres
      install:
        - poetry install
      env:
        - APP_NAME="data-classification-app"
        - BASE_DOMAIN="${APP_NAME}.azurewebsites.net"
        - ALLOWED_HOSTS="${BASE_DOMAIN},127.0.0.1,localhost,0.0.0.0"
        - DEBUG=1
        - DATABASE="postgres"
        - DB_HOST="localhost"
        - DB_PASSWORD="haven"
        - DB_USER="haven"
        - DB_NAME="haven"
        - DB_PORT="5432"
        - DB_ENGINE="django.db.backends.postgresql"
        - DJANGO_SETTINGS_MODULE="haven.settings.test"
      script:
        - poetry run pytest --ignore=node_modules --cov-config=./.coveragerc --cov-report term-missing
    - name: check for missing migrations
      language: python
      python:
        - "3.8"
      before_install:
        - pip install poetry
      install:
        - poetry install
      script:
        - ./manage.py makemigrations --check --dry-run --settings=haven.settings.test
    - name: verify built JS files are up to date
      language: node_js
      node_js:
        - 10
      before_script:
        - npm install -g gulp-cli
      script:
        - cd static
        - npm install
        - gulp
        - git diff --exit-code --numstat
    - name: run deployment checks
      language: python
      python:
        - "3.8"
      env:
        - SECRET_KEY="notasecret"
      addons:
        apt:
          packages:
            - unixodbc-dev
      before_install:
        - pip install poetry
      install:
        - poetry install --no-dev
      script:
        - ./manage.py check --deploy --settings=haven.settings.production
